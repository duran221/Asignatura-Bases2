	


--QUEREMOS ESTABLECER ESTRUCTURAS PARA ALMACENAR INFORMACIÓN, ANTES DE QUE EL INSERTE, SALVAMOS LO QUE EL 
--VA A ACTUALIZAR, CON UN DISPARO FOR EACH ROW ALMACENO ESTOS DATOS, LUEGO RELIZO UN DISPARO QUE EVALÚE SI SE
--VULNERÓ LA TABLA, LA AGREGACIÓN DEBE IR EN UN MOMENTO DESPUÉS, SE CREA UNA COLECCION
CREATE OR REPLACE PACKAGE GLOBAL1 AS


--Establecer estructuras:
TYPE AUXILIARID IS TABLE OF NUMBER(5)
INDEX BY BINARY_INTEGER;

ALMACENID AUXILIARID;

ITERA INTEGER:=0;


END GLOBAL1;



--CREAMOS EL TRIGGER PARA EVITAR LA MUTACIÓN,
--ANTES DE QUE SE REALICE LA ACTUALIZACIÓN O INSERCION
--EL EVALÚA LINEA POR LINEA
CREATE OR REPLACE TRIGGER MOMENTOANTES
BEFORE INSERT OR UPDATE OF REPRESENTANTE ON ESTUDIANTESBK

FOR EACH ROW

BEGIN
    
    
    GLOBAL1.ITERA:=GLOBAL1.ITERA+1;


    GLOBAL.ALMACENID(GLOBAL1.ITERA):= :NEW.REPRESENTANTE;
    

END MOMENTOANTES;

END;
/




CREATE OR REPLACE TRIGGER MOMENDODESPUES
AFTER INSERT OR UPDATE OF REPRESENTANTE ON ESTUDIANTESBK


DECLARE

    LIMITE INTEGER:=3;
    MENSAJE VARCHAR2(30):='VULNERA EL LIMITE';
    INFO VARCHAR2(80);
    VID NUMBER(5);
    CUANTOS INTEGER:=0;


BEGIN

    FOR I IN 1..GLOBAL.ITERA
    LOOP
        
        VID:= GLOBAL1.ALMACENID(I);
        
        SELECT COUNT(*) INTO CUANTOS
        FROM ESTUDIANTESBK
        WHERE REPRESENTANTE=VID;
        
        IF (CUANTOS>LIMITE) THEN
            SELECT NOMBRE||APELLIDO
            INTO INFO
            FROM ESTUDIANTES WHERE ID=VID;
            
            RAISE_APPLICATION_ERROR(-20000, 'EL REPRESENTANTE: '||INFO||MENSAJE);
            
        END IF;
        
    END LOOP;
    
    GLOBAL1.ITERA:=0;
    

END MOMENTODESPUES;

--CONSULTAR CÚAL ES EL ORDEN DE LOS DISPAROS EN UNA MISMA TABLA




















--QUEREMOS ESTABLECER ESTRUCTURAS PARA ALMACENAR INFORMACIÓN, ANTES DE QUE EL INSERTE, SALVAMOS LO QUE EL 
--VA A ACTUALIZAR, CON UN DISPARO FOR EACH ROW ALMACENO ESTOS DATOS, LUEGO RELIZO UN DISPARO QUE EVALÚE SI SE
--VULNERÓ LA TABLA, LA AGREGACIÓN DEBE IR EN UN MOMENTO DESPUÉS, SE CREA UNA COLECCION
CREATE OR REPLACE PACKAGE GLOBAL1 AS


--Establecer estructuras:
TYPE AUXILIARID IS TABLE OF NUMBER(5)
INDEX BY BINARY_INTEGER;

ALMACENID AUXILIARID;

ITERA INTEGER:=0;


END GLOBAL1;



--CREAMOS EL TRIGGER PARA EVITAR LA MUTACIÓN,
--ANTES DE QUE SE REALICE LA ACTUALIZACIÓN O INSERCION
--EL EVALÚA LINEA POR LINEA
CREATE OR REPLACE TRIGGER MOMENTOANTES
BEFORE INSERT OR UPDATE OF REPRESENTANTE ON ESTUDIANTESBK

FOR EACH ROW

BEGIN
    
    
    GLOBAL1.ITERA:=GLOBAL1.ITERA+1;

    GLOBAL1.ALMACENID(GLOBAL1.ITERA):= :NEW.REPRESENTANTE;
    

END MOMENTOANTES;
/




CREATE OR REPLACE TRIGGER MOMENDODESPUES
AFTER INSERT OR UPDATE OF REPRESENTANTE ON ESTUDIANTESBK


DECLARE

    LIMITE INTEGER:=3;
    MENSAJE VARCHAR2(30):='VULNERA EL LIMITE';
    INFO VARCHAR2(80);
    VID NUMBER(5);
    CUANTOS INTEGER:=0;


BEGIN

    FOR I IN 1..GLOBAL1.ITERA
    LOOP
        
        VID:= GLOBAL1.ALMACENID(I);
        
        SELECT COUNT(*) INTO CUANTOS
        FROM ESTUDIANTESBK
        WHERE REPRESENTANTE=VID;
        
        IF (CUANTOS>LIMITE) THEN
            SELECT NOMBRE||APELLIDO
            INTO INFO
            FROM ESTUDIANTES WHERE ID=VID;
            
            RAISE_APPLICATION_ERROR(-20000, 'EL REPRESENTANTE: '||INFO||MENSAJE);
            
        END IF;
        
    END LOOP;
    
    GLOBAL1.ITERA:=0;
    

END MOMENTODESPUES;

--CONSULTAR CÚAL ES EL ORDEN DE LOS DISPAROS EN UNA MISMA TABLA
--EL NOMBRE DEL ESTUDIANTE;


